name: "Smoke: .lignore + whitelist"

# Real-tmutil smoke tests for .lignore override files and whitelist filtering.
# Covers: negation (re-include), addition (extra exclusion), and whitelist.

on:
  push:
    branches: ["main"]
    paths: ["src/**", "Cargo.toml", "Cargo.lock", ".github/workflows/**"]
  pull_request:
    paths: ["src/**", "Cargo.toml", "Cargo.lock", ".github/workflows/**"]

env:
  CARGO_TERM_COLOR: always

jobs:
  smoke-lignore:
    name: .lignore + whitelist smoke tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build

      - name: Create xattr helpers
        run: |
          cat > "$RUNNER_TEMP/h.sh" <<'EOF'
          assert_xattr()    { xattr "$1" 2>/dev/null | grep -q com_apple_backup_excludeItem || { echo "FAIL: $2 — no xattr on $1"; exit 1; }; echo "OK: $2"; }
          assert_no_xattr() { if xattr "$1" 2>/dev/null | grep -q com_apple_backup_excludeItem; then echo "FAIL: $2 — xattr on $1"; exit 1; fi; echo "OK: $2"; }
          make_config() { printf 'search_paths = ["%s"]\nignored_paths = []\nwhitelist = %s\nexclusion_mode = "sticky"\n' "$1" "${2:-[]}" > "$3"; }
          EOF

      # ── .lignore negation ────────────────────────────────────────────────────
      - name: ".lignore negation: re-include gitignored dir"
        run: |
          source "$RUNNER_TEMP/h.sh"
          R="$RUNNER_TEMP/lignore-neg"
          C="$RUNNER_TEMP/lignore-neg.toml"
          mkdir -p "$R/.git" "$R/target" "$R/node_modules"
          printf 'target/\nnode_modules/\n' > "$R/.gitignore"
          printf '!target/\n' > "$R/.lignore"
          make_config "$R" "[]" "$C"
          ./target/debug/letitgo --config "$C" run --search-path "$R"
          assert_no_xattr "$R/target"       "negation: target/ re-included"
          assert_xattr    "$R/node_modules" "negation: node_modules/ still excluded"
          ./target/debug/letitgo --config "$C" reset --yes 2>/dev/null || true

      # ── .lignore addition ────────────────────────────────────────────────────
      - name: ".lignore addition: exclude non-gitignored dir"
        run: |
          source "$RUNNER_TEMP/h.sh"
          R="$RUNNER_TEMP/lignore-add"
          C="$RUNNER_TEMP/lignore-add.toml"
          mkdir -p "$R/.git" "$R/target" "$R/data/large"
          printf 'target/\n' > "$R/.gitignore"
          printf 'data/\n' > "$R/.lignore"
          make_config "$R" "[]" "$C"
          ./target/debug/letitgo --config "$C" run --search-path "$R"
          assert_xattr "$R/target" "addition: target/ via .gitignore"
          assert_xattr "$R/data"   "addition: data/ via .lignore"
          ./target/debug/letitgo --config "$C" reset --yes 2>/dev/null || true

      # ── .lignore combined: addition + negation in same file ──────────────────
      - name: ".lignore combined: add data/, negate target/"
        run: |
          source "$RUNNER_TEMP/h.sh"
          R="$RUNNER_TEMP/lignore-combo"
          C="$RUNNER_TEMP/lignore-combo.toml"
          mkdir -p "$R/.git" "$R/target" "$R/node_modules" "$R/data"
          printf 'target/\nnode_modules/\n' > "$R/.gitignore"
          printf '!target/\ndata/\n' > "$R/.lignore"
          make_config "$R" "[]" "$C"
          ./target/debug/letitgo --config "$C" run --search-path "$R"
          assert_no_xattr "$R/target"       "combo: target/ negated"
          assert_xattr    "$R/node_modules" "combo: node_modules/ still excluded"
          assert_xattr    "$R/data"         "combo: data/ added by .lignore"
          ./target/debug/letitgo --config "$C" reset --yes 2>/dev/null || true

      # ── Nested .lignore in subdirectory ──────────────────────────────────────
      - name: "nested .lignore: subdirectory scope"
        run: |
          source "$RUNNER_TEMP/h.sh"
          R="$RUNNER_TEMP/lignore-nested"
          C="$RUNNER_TEMP/lignore-nested.toml"
          mkdir -p "$R/.git" "$R/target" "$R/src/generated"
          printf 'target/\n' > "$R/.gitignore"
          # Subdirectory .lignore adds src/generated/ to exclusions
          printf 'generated/\n' > "$R/src/.lignore"
          make_config "$R" "[]" "$C"
          ./target/debug/letitgo --config "$C" run --search-path "$R"
          assert_xattr "$R/target"        "nested: target/ via .gitignore"
          assert_xattr "$R/src/generated" "nested: src/generated/ via src/.lignore"
          ./target/debug/letitgo --config "$C" reset --yes 2>/dev/null || true

      # ── Whitelist filtering ──────────────────────────────────────────────────
      - name: "whitelist: .env not excluded"
        run: |
          source "$RUNNER_TEMP/h.sh"
          R="$RUNNER_TEMP/whitelist"
          C="$RUNNER_TEMP/whitelist.toml"
          mkdir -p "$R/.git" "$R/target"
          printf 'SECRET=1' > "$R/.env"
          printf 'target/\n.env\n' > "$R/.gitignore"
          make_config "$R" '["**/.env"]' "$C"
          ./target/debug/letitgo --config "$C" run --search-path "$R"
          assert_xattr    "$R/target" "whitelist: target/ excluded"
          assert_no_xattr "$R/.env"   "whitelist: .env preserved"
          ./target/debug/letitgo --config "$C" reset --yes 2>/dev/null || true

      # ── Whitelist with multiple patterns ─────────────────────────────────────
      - name: "whitelist: multiple glob patterns"
        run: |
          source "$RUNNER_TEMP/h.sh"
          R="$RUNNER_TEMP/wl-multi"
          C="$RUNNER_TEMP/wl-multi.toml"
          mkdir -p "$R/.git" "$R/target" "$R/config"
          printf 'SECRET=1' > "$R/.env"
          printf 'db:\n  url: postgres://...' > "$R/config/application.yml"
          printf 'target/\n.env\nconfig/\n' > "$R/.gitignore"
          make_config "$R" '["**/.env", "**/application.yml"]' "$C"
          ./target/debug/letitgo --config "$C" run --search-path "$R"
          assert_xattr    "$R/target"                  "wl-multi: target/ excluded"
          assert_no_xattr "$R/.env"                    "wl-multi: .env preserved"
          assert_no_xattr "$R/config/application.yml"  "wl-multi: application.yml preserved"
          ./target/debug/letitgo --config "$C" reset --yes 2>/dev/null || true

      # ── Cleanup ──────────────────────────────────────────────────────────────
      - name: Cleanup
        if: always()
        run: |
          if [ -f ./target/debug/letitgo ]; then
            for c in "$RUNNER_TEMP"/*.toml; do
              [ -f "$c" ] && ./target/debug/letitgo --config "$c" reset --yes 2>/dev/null || true
            done
          fi
